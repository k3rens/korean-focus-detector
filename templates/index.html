<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Focus-detecting Translation/Transcription Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f9; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9rem; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { background-color: #eff6ff; color: #1f2937; font-weight: 600; }
        .focus-row { background-color: #fffafa; border-left: 4px solid #fecaca; }
        .threshold-card { transition: all 0.2s ease; }
        .threshold-card:hover { border-color: #bfdbfe; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="text-2xl font-bold mb-4 border-b pb-2 text-gray-800">Korean Focus-detecting Translation/Transcription Demo</h1>
    
    <div class="flex items-center space-x-4 mb-6">
        <button id="recordBtn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-200">
            Start Recording
        </button>
        <div id="recordingIndicator" class="flex items-center space-x-2 hidden">
            <span class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
            </span>
            <span class="text-red-500 font-bold">Recording...</span>
        </div>
        <span id="timer" class="text-lg font-mono text-gray-600">0:00</span>
    </div>

    <div id="status" class="p-3 bg-gray-100 rounded mb-6 text-sm text-gray-600 border border-gray-200">Ready.</div>

    <div id="resultsContainer" class="space-y-8">
        <!-- Each threshold result will be rendered here -->
    </div>
</div>

<script>
let mediaRecorder, audioChunks = [], startTime, timerInterval;
const SERVER_URL = "http://127.0.0.1:8000"; 

const recordBtn = document.getElementById("recordBtn");
const indicator = document.getElementById("recordingIndicator");
const timer = document.getElementById("timer");
const status = document.getElementById("status");
const resultsContainer = document.getElementById("resultsContainer");

recordBtn.onclick = async () => {
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        recordBtn.textContent = "Processing...";
        recordBtn.disabled = true;
        indicator.classList.add("hidden");
        clearInterval(timerInterval);
    } else {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const formData = new FormData();
                formData.append('file', new Blob(audioChunks, { type: 'audio/webm' }), 'audio.webm');
                status.textContent = "Analyzing pitch and generating translations...";
                try {
                    const res = await fetch(`${SERVER_URL}/translate/`, { method: "POST", body: formData });
                    const data = await res.json();
                    
                    if (data.error) throw new Error(data.error);

                    resultsContainer.innerHTML = data.all_results.map(res => `
                        <div class="threshold-card bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                            <div class="bg-gray-50 px-4 py-2 border-b flex justify-between items-center">
                                <span class="text-sm font-bold text-blue-600">Threshold: ${res.threshold}% Pitch Ratio</span>
                                <span class="text-xs text-gray-500">Post-Focal Compression Analysis</span>
                            </div>
                            
                            <div class="p-4 bg-white">
                                <div class="mb-4">
                                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Korean Focus Marking</h3>
                                    <p class="text-lg text-gray-800 font-medium">${res.ko_text}</p>
                                </div>
                                
                                <div class="mb-4 p-3 bg-blue-50 rounded-lg border-l-4 border-blue-400">
                                    <h3 class="text-xs font-bold text-blue-700 uppercase tracking-widest mb-1">English Translation</h3>
                                    <p class="text-md text-gray-700 font-semibold">${res.en_text}</p>
                                </div>

                                <table>
                                    <thead>
                                        <tr>
                                            <th>Word</th>
                                            <th>Mean Pitch (Hz)</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${res.table_data.map(r => `
                                            <tr class="${r.emphasis === 'Focus' ? 'focus-row' : ''}">
                                                <td class="font-medium">${r.word}</td>
                                                <td class="text-gray-500">${r.pitch > 0 ? r.pitch.toFixed(1) : '-'}</td>
                                                <td>
                                                    <span class="${r.emphasis === 'Focus' ? 'text-red-600 font-bold' : 'text-gray-300'}">
                                                        ${r.emphasis}
                                                    </span>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `).join('');
                    
                    status.textContent = "Analysis complete.";
                } catch (e) { 
                    status.textContent = "Error: " + e.message; 
                    console.error(e);
                }
                recordBtn.textContent = "Start Recording"; 
                recordBtn.disabled = false;
            };
            mediaRecorder.start();
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const el = Math.floor((Date.now() - startTime) / 1000);
                timer.textContent = `0:${el.toString().padStart(2, '0')}`;
            }, 500);
            recordBtn.textContent = "Stop Recording"; 
            indicator.classList.remove("hidden");
        } catch (e) { status.textContent = "Mic error."; }
    }
};
</script>
</body>
</html>